<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÎßûÏ∂§ ÏßÄÏõêÍ∏à Ï∞æÍ∏∞ - Î≥¥Ï°∞Í∏à24</title>
    <meta name="description" content="ÎÇòÏóêÍ≤å ÎßûÎäî Ï†ïÎ∂Ä ÏßÄÏõêÍ∏àÏùÑ Ï∞æÏïÑÎ≥¥ÏÑ∏Ïöî. Î™á Í∞ÄÏßÄ ÏßàÎ¨∏Ïóê ÎãµÌïòÎ©¥ Î∞õÏùÑ Ïàò ÏûàÎäî Î≥¥Ï°∞Í∏àÏùÑ Ï∂îÏ≤úÌï¥ÎìúÎ¶ΩÎãàÎã§.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563EB;
            --primary-dark: #1D4ED8;
            --primary-light: #3B82F6;
            --primary-50: #EFF6FF;
            --primary-100: #DBEAFE;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-900: #111827;
            --gray-800: #1F2937;
            --gray-700: #374151;
            --gray-600: #4B5563;
            --gray-500: #6B7280;
            --gray-400: #9CA3AF;
            --gray-300: #D1D5DB;
            --gray-200: #E5E7EB;
            --gray-100: #F3F4F6;
            --gray-50: #F9FAFB;
            --white: #FFFFFF;
            --gradient: linear-gradient(135deg, #2563EB 0%, #7C3AED 100%);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1);
            --radius-sm: 8px;
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { 
            height: 100%; 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-font-smoothing: antialiased;
        }
        button { cursor: pointer; font-family: inherit; }
        input, select { font-family: inherit; }

        /* Wrapper */
        .app-wrapper {
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        /* Container */
        .chat-container {
            width: 100%;
            max-width: 460px;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            max-height: calc(100dvh - 32px);
            overflow: hidden;
        }

        /* Header */
        .chat-header {
            background: var(--gradient);
            color: var(--white);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .header-icon {
            width: 52px;
            height: 52px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .header-icon svg { width: 28px; height: 28px; }
        .header-content { flex: 1; }
        .header-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 2px; }
        .header-desc { font-size: 0.813rem; opacity: 0.9; }
        .btn-reset {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .btn-reset:hover { background: rgba(255,255,255,0.25); }
        .btn-reset svg { width: 20px; height: 20px; }

        /* Progress */
        .progress-section {
            padding: 14px 20px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--gray-200);
            border-radius: var(--radius-full);
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--gradient);
            border-radius: var(--radius-full);
            transition: width 0.4s ease;
            width: 0%;
        }
        .progress-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
            white-space: nowrap;
        }

        /* Messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 300px;
        }
        .msg {
            display: flex;
            gap: 10px;
            max-width: 88%;
            animation: fadeSlideIn 0.3s ease;
        }
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg.bot { align-self: flex-start; }
        .msg.user { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar {
            width: 36px;
            height: 36px;
            background: var(--gradient);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .msg-avatar svg { width: 20px; height: 20px; color: var(--white); }
        .msg-bubble {
            padding: 14px 16px;
            border-radius: var(--radius);
            font-size: 0.938rem;
            line-height: 1.6;
        }
        .msg.bot .msg-bubble {
            background: var(--gray-100);
            color: var(--gray-800);
            border-top-left-radius: 4px;
        }
        .msg.user .msg-bubble {
            background: var(--gradient);
            color: var(--white);
            border-top-right-radius: 4px;
        }
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 14px 16px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--gray-400);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* Input Area */
        .input-section {
            padding: 16px 20px 20px;
            background: var(--white);
            border-top: 1px solid var(--gray-100);
        }
        .options-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .options-list.grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
        }
        .btn-option {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 14px 16px;
            font-size: 0.938rem;
            font-weight: 500;
            color: var(--gray-700);
            text-align: center;
            transition: 0.2s;
        }
        .btn-option:hover {
            border-color: var(--primary);
            background: var(--primary-50);
            color: var(--primary);
        }
        .btn-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: var(--white);
        }
        .btn-option .sub { display: block; font-size: 0.75rem; opacity: 0.75; margin-top: 4px; }

        /* Multi-select */
        .btn-option.multi {
            position: relative;
            padding-left: 44px;
            text-align: left;
        }
        .btn-option.multi::before {
            content: '';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-radius: 4px;
        }
        .btn-option.multi.selected::before {
            background: var(--primary);
            border-color: var(--primary);
        }
        .btn-option.multi.selected::after {
            content: '';
            position: absolute;
            left: 19px;
            top: 50%;
            transform: translateY(-60%) rotate(45deg);
            width: 5px;
            height: 10px;
            border: solid var(--white);
            border-width: 0 2px 2px 0;
        }

        /* Action Buttons */
        .action-row {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        .btn-back {
            flex: 0 0 auto;
            min-width: 72px;
            padding: 14px 16px;
            background: var(--white);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 0.938rem;
            font-weight: 600;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: 0.2s;
        }
        .btn-back:hover { border-color: var(--gray-400); background: var(--gray-50); }
        .btn-back:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-back svg { width: 18px; height: 18px; }
        .btn-confirm {
            flex: 1;
            padding: 14px 20px;
            background: var(--gradient);
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            color: var(--white);
            transition: 0.2s;
        }
        .btn-confirm:hover { opacity: 0.9; }
        .btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Select */
        .select-group { display: flex; flex-direction: column; gap: 10px; }
        .custom-select {
            width: 100%;
            padding: 14px 40px 14px 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 0.938rem;
            color: var(--gray-700);
            background: var(--white) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='none' stroke='%236B7280' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") no-repeat right 12px center;
            background-size: 20px;
            appearance: none;
        }
        .custom-select:focus { outline: none; border-color: var(--primary); }

        /* Birth & Gender */
        .birth-form { display: flex; flex-direction: column; gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { font-size: 0.875rem; font-weight: 600; color: var(--gray-700); }
        .birth-inputs { display: flex; gap: 8px; align-items: center; }
        .input-wrap { flex: 1; }
        .input-wrap.wide { flex: 1.4; }
        .birth-input {
            width: 100%;
            padding: 14px 10px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 1rem;
            text-align: center;
            -moz-appearance: textfield;
        }
        .birth-input::-webkit-outer-spin-button,
        .birth-input::-webkit-inner-spin-button { -webkit-appearance: none; }
        .birth-input:focus { outline: none; border-color: var(--primary); }
        .birth-input::placeholder { color: var(--gray-400); font-size: 0.875rem; }
        .input-suffix { font-size: 0.875rem; color: var(--gray-500); width: 20px; }
        .gender-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

        /* Result Modal */
        .result-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: 0.2s;
        }
        .result-modal.show { opacity: 1; visibility: visible; }
        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .modal-panel {
            position: relative;
            width: 100%;
            max-width: 520px;
            max-height: 88vh;
            background: var(--white);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .result-modal.show .modal-panel { transform: translateY(0); }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .modal-title { font-size: 1.25rem; font-weight: 700; color: var(--gray-900); }
        .btn-close {
            width: 36px;
            height: 36px;
            background: var(--gray-100);
            border: none;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .btn-close:hover { background: var(--gray-200); }
        .btn-close svg { width: 20px; height: 20px; color: var(--gray-600); }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }
        .stat-box.primary { background: var(--primary-50); }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
        .stat-label { font-size: 0.813rem; color: var(--gray-600); }

        /* Page Navigation */
        .page-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--gray-50);
            border-radius: var(--radius);
            margin-bottom: 16px;
        }
        .page-nav-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            transition: 0.2s;
        }
        .page-nav-btn:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); }
        .page-nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-nav-btn svg { width: 16px; height: 16px; }
        .page-nav-info { font-size: 0.875rem; font-weight: 600; color: var(--gray-600); }

        /* Results List */
        .results-list { display: flex; flex-direction: column; gap: 12px; }
        .result-item {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 16px;
            position: relative;
            transition: 0.2s;
        }
        .result-item:hover { border-color: var(--primary-100); box-shadow: var(--shadow); }
        .result-item.recommended {
            border-color: var(--warning);
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
        }
        .result-item.recommended::before {
            content: '‚≠ê Ï∂îÏ≤ú';
            position: absolute;
            top: -10px;
            right: 14px;
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: var(--white);
            font-size: 0.688rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: var(--radius-full);
        }
        .result-badge {
            display: inline-block;
            background: var(--primary);
            color: var(--white);
            font-size: 0.688rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }
        .result-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            line-height: 1.4;
            margin-bottom: 8px;
        }
        .result-org { font-size: 0.813rem; color: var(--gray-500); margin-bottom: 8px; }
        .result-desc {
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.5;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .result-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary);
            text-decoration: none;
        }
        .result-link:hover { text-decoration: underline; }
        .result-link svg { width: 16px; height: 16px; }

        /* Pagination */
        .pagination {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-100);
        }
        .page-num {
            min-width: 36px;
            height: 36px;
            padding: 0 8px;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            background: var(--white);
            color: var(--gray-600);
            font-size: 0.813rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .page-num:hover:not(:disabled):not(.active):not(.dots) {
            border-color: var(--primary);
            color: var(--primary);
        }
        .page-num:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-num.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--white);
        }
        .page-num.dots {
            border: none;
            background: transparent;
            cursor: default;
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 48px 20px;
        }
        .no-results-icon { font-size: 3.5rem; margin-bottom: 16px; }
        .no-results-title { font-size: 1.125rem; font-weight: 600; color: var(--gray-900); margin-bottom: 8px; }
        .no-results-desc { font-size: 0.875rem; color: var(--gray-500); }

        /* Debug Panel (Hidden by default) */
        .debug-panel {
            margin-top: 20px;
            padding: 16px;
            background: #1e1e1e;
            border-radius: var(--radius);
            display: none;
        }
        .debug-panel.show { display: block; }
        .debug-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #10B981;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .debug-content {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #E5E7EB;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 520px) {
            .app-wrapper { padding: 0; }
            .chat-container {
                max-width: 100%;
                border-radius: 0;
                max-height: 100dvh;
            }
            .chat-header {
                padding: 16px;
                padding-top: max(16px, env(safe-area-inset-top));
            }
            .modal-panel { max-width: 100%; max-height: 92vh; }
            .page-num { min-width: 32px; height: 32px; font-size: 0.75rem; }
        }

        @media (min-width: 521px) {
            .result-modal { align-items: center; }
            .modal-panel { border-radius: var(--radius-xl); max-height: 85vh; }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="chat-container">
            <header class="chat-header">
                <div class="header-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                    </svg>
                </div>
                <div class="header-content">
                    <h1 class="header-title">ÎßûÏ∂§ ÏßÄÏõêÍ∏à Ï∞æÍ∏∞</h1>
                    <p class="header-desc">Î™á Í∞ÄÏßÄ ÏßàÎ¨∏ÏúºÎ°ú Î∞õÏùÑ Ïàò ÏûàÎäî ÏßÄÏõêÍ∏àÏùÑ Ï∞æÏïÑÎìúÎ†§Ïöî</p>
                </div>
                <button class="btn-reset" id="resetBtn" title="Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                </button>
            </header>

            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span class="progress-label" id="progressLabel">ÏãúÏûëÌïòÍ∏∞</span>
            </div>

            <main class="messages-container" id="messagesContainer"></main>
            <div class="input-section" id="inputSection"></div>
        </div>
    </div>

    <div class="result-modal" id="resultModal">
        <div class="modal-backdrop" id="modalBackdrop"></div>
        <div class="modal-panel">
            <div class="modal-header">
                <h2 class="modal-title">üéâ ÎßûÏ∂§ ÏßÄÏõêÍ∏à Í≤ÄÏÉâ ÏôÑÎ£å!</h2>
                <button class="btn-close" id="closeModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // ============ CONFIG ============
        const CONFIG = {
            API_URL: 'https://subsidy-api-proxy.peopleidentityc.workers.dev',
            ITEMS_PER_PAGE: 20,
            MAX_ITEMS: 1000,
            DEBUG: false // ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê ÌëúÏãú Ïó¨Î∂Ä
        };

        // ============ APP STATE ============
        const App = {
            state: {
                currentStep: 0,
                answers: {},
                history: [],
                services: [],
                totalCount: 0,
                currentPage: 1,
                debugInfo: null
            },

            elements: {},

            // ============ QUESTIONS ============
            questions: [
                {
                    id: 'intro',
                    type: 'single',
                    message: 'ÏïàÎÖïÌïòÏÑ∏Ïöî! üëã\nÎÇòÏóêÍ≤å ÎßûÎäî Ï†ïÎ∂Ä ÏßÄÏõêÍ∏àÏùÑ Ï∞æÏïÑÎìúÎ¶¥Í≤åÏöî.\n\nÏñ¥Îñ§ Ïú†ÌòïÏúºÎ°ú Í≤ÄÏÉâÌïòÏãúÍ≤†Ïñ¥Ïöî?',
                    options: [
                        { value: 'personal', label: 'üë§ Í∞úÏù∏/Í∞ÄÍµ¨' },
                        { value: 'business', label: 'üè™ ÏÜåÏÉÅÍ≥µÏù∏' },
                        { value: 'corp', label: 'üè¢ Î≤ïÏù∏/Í∏∞Í¥Ä' }
                    ]
                },
                {
                    id: 'region',
                    type: 'region',
                    condition: { intro: 'personal' },
                    message: 'Í±∞Ï£ºÌïòÏãúÎäî ÏßÄÏó≠ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.',
                    progress: { current: 1, total: 5 }
                },
                {
                    id: 'birthGender',
                    type: 'birthGender',
                    condition: { intro: 'personal' },
                    message: 'ÏÉùÎÖÑÏõîÏùºÍ≥º ÏÑ±Î≥ÑÏùÑ ÏïåÎ†§Ï£ºÏÑ∏Ïöî.',
                    progress: { current: 2, total: 5 }
                },
                {
                    id: 'income',
                    type: 'single',
                    condition: { intro: 'personal' },
                    message: 'Í∞ÄÍµ¨Ïùò ÏÜåÎìù ÏàòÏ§ÄÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n\nüí° 2025ÎÖÑ Í∏∞Ï§ÄÏ§ëÏúÑÏÜåÎìù\n4Ïù∏Í∞ÄÍµ¨ Í∏∞Ï§Ä: Ïõî ÏïΩ 572ÎßåÏõê',
                    options: [
                        { value: '0~50', label: '50% Ïù¥Ìïò', sub: 'Ïõî 286ÎßåÏõê Ïù¥Ìïò' },
                        { value: '51~75', label: '51~75%', sub: 'Ïõî 286~429ÎßåÏõê' },
                        { value: '76~100', label: '76~100%', sub: 'Ïõî 429~572ÎßåÏõê' },
                        { value: '101~200', label: '101~200%', sub: 'Ïõî 572~1,145ÎßåÏõê' },
                        { value: '200~', label: '200% Ï¥àÍ≥º', sub: 'Ïõî 1,145ÎßåÏõê Ï¥àÍ≥º' }
                    ],
                    gridClass: 'grid-2',
                    progress: { current: 3, total: 5 }
                },
                {
                    id: 'personalChar',
                    type: 'multi',
                    condition: { intro: 'personal' },
                    message: 'Ìï¥ÎãπÎêòÎäî Í∞úÏù∏ ÌäπÏÑ±ÏùÑ Î™®Îëê ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.',
                    options: [
                        { value: 'JA0101', label: 'ÏòàÎπÑÎ∂ÄÎ∂Ä/ÎÇúÏûÑ' },
                        { value: 'JA0102', label: 'ÏûÑÏã†Î∂Ä' },
                        { value: 'JA0103', label: 'Ï∂úÏÇ∞/ÏûÖÏñë' },
                        { value: 'JA0201', label: 'ÏòÅÏú†ÏïÑ ÏûêÎÖÄ' },
                        { value: 'JA0301', label: 'Ïû•Ïï†Ïù∏' },
                        { value: 'JA0302', label: 'Íµ≠Í∞ÄÎ≥¥ÌõàÎåÄÏÉÅÏûê' },
                        { value: 'JA0401', label: 'ÎÜçÏóÖÏù∏' },
                        { value: 'JA0501', label: 'Ï§ë/Í≥†Îì±ÌïôÏÉù' },
                        { value: 'JA0502', label: 'ÎåÄÌïôÏÉù' },
                        { value: 'JA0601', label: 'Í∑ºÎ°úÏûê/ÏßÅÏû•Ïù∏' },
                        { value: 'JA0602', label: 'Íµ¨ÏßÅÏûê/Ïã§ÏóÖÏûê' },
                        { value: 'JA9999', label: 'Ìï¥ÎãπÏóÜÏùå' }
                    ],
                    gridClass: 'grid-2',
                    progress: { current: 4, total: 5 }
                },
                {
                    id: 'familyChar',
                    type: 'multi',
                    condition: { intro: 'personal' },
                    message: 'Ìï¥ÎãπÎêòÎäî Í∞ÄÍµ¨ ÌäπÏÑ±ÏùÑ Î™®Îëê ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.',
                    options: [
                        { value: 'JA0701', label: 'Îã§Î¨∏ÌôîÍ∞ÄÏ†ï' },
                        { value: 'JA0702', label: 'Î∂ÅÌïúÏù¥ÌÉàÏ£ºÎØº' },
                        { value: 'JA0703', label: 'ÌïúÎ∂ÄÎ™®/Ï°∞ÏÜêÍ∞ÄÏ†ï' },
                        { value: 'JA0704', label: '1Ïù∏ Í∞ÄÍµ¨' },
                        { value: 'JA0705', label: 'Îã§ÏûêÎÖÄ Í∞ÄÍµ¨' },
                        { value: 'JA0706', label: 'Î¨¥Ï£ºÌÉù ÏÑ∏ÎåÄ' },
                        { value: 'JA9999', label: 'Ìï¥ÎãπÏóÜÏùå' }
                    ],
                    gridClass: 'grid-2',
                    progress: { current: 5, total: 5 }
                },
                // ÏÜåÏÉÅÍ≥µÏù∏
                {
                    id: 'bizRegion',
                    type: 'region',
                    condition: { intro: 'business' },
                    message: 'ÏÇ¨ÏóÖÏû• ÏÜåÏû¨ÏßÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.',
                    progress: { current: 1, total: 2 }
                },
                {
                    id: 'bizType',
                    type: 'single',
                    condition: { intro: 'business' },
                    message: 'ÏóÖÏ¢ÖÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.',
                    options: [
                        { value: 'food', label: 'üçΩÔ∏è ÏùåÏãùÏ†êÏóÖ' },
                        { value: 'manufacture', label: 'üè≠ Ï†úÏ°∞ÏóÖ' },
                        { value: 'retail', label: 'üõí ÎèÑÏÜåÎß§ÏóÖ' },
                        { value: 'service', label: 'üíº ÏÑúÎπÑÏä§ÏóÖ' },
                        { value: 'other', label: 'üì¶ Í∏∞ÌÉÄ' }
                    ],
                    gridClass: 'grid-2',
                    progress: { current: 2, total: 2 }
                },
                // Î≤ïÏù∏/Í∏∞Í¥Ä
                {
                    id: 'corpRegion',
                    type: 'region',
                    condition: { intro: 'corp' },
                    message: 'ÏÇ¨ÏóÖÏû• ÏÜåÏû¨ÏßÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.',
                    progress: { current: 1, total: 2 }
                },
                {
                    id: 'corpBizType',
                    type: 'single',
                    condition: { intro: 'corp' },
                    message: 'ÏóÖÏ¢ÖÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.',
                    options: [
                        { value: 'manufacture', label: 'üè≠ Ï†úÏ°∞ÏóÖ' },
                        { value: 'agri', label: 'üåæ ÎÜçÎ¶ºÏñ¥ÏóÖ' },
                        { value: 'it', label: 'üíª Ï†ïÎ≥¥ÌÜµÏã†ÏóÖ' },
                        { value: 'other', label: 'üì¶ Í∏∞ÌÉÄ' }
                    ],
                    gridClass: 'grid-2',
                    progress: { current: 2, total: 2 }
                }
            ],

            // ============ REGIONS DATA ============
            regions: {
                'ÏÑúÏö∏': ['Í∞ïÎÇ®Íµ¨','Í∞ïÎèôÍµ¨','Í∞ïÎ∂ÅÍµ¨','Í∞ïÏÑúÍµ¨','Í¥ÄÏïÖÍµ¨','Í¥ëÏßÑÍµ¨','Íµ¨Î°úÍµ¨','Í∏àÏ≤úÍµ¨','ÎÖ∏ÏõêÍµ¨','ÎèÑÎ¥âÍµ¨','ÎèôÎåÄÎ¨∏Íµ¨','ÎèôÏûëÍµ¨','ÎßàÌè¨Íµ¨','ÏÑúÎåÄÎ¨∏Íµ¨','ÏÑúÏ¥àÍµ¨','ÏÑ±ÎèôÍµ¨','ÏÑ±Î∂ÅÍµ¨','ÏÜ°ÌååÍµ¨','ÏñëÏ≤úÍµ¨','ÏòÅÎì±Ìè¨Íµ¨','Ïö©ÏÇ∞Íµ¨','ÏùÄÌèâÍµ¨','Ï¢ÖÎ°úÍµ¨','Ï§ëÍµ¨','Ï§ëÎûëÍµ¨'],
                'Î∂ÄÏÇ∞': ['Í∞ïÏÑúÍµ¨','Í∏àÏ†ïÍµ¨','Í∏∞Ïû•Íµ∞','ÎÇ®Íµ¨','ÎèôÍµ¨','ÎèôÎûòÍµ¨','Î∂ÄÏÇ∞ÏßÑÍµ¨','Î∂ÅÍµ¨','ÏÇ¨ÏÉÅÍµ¨','ÏÇ¨ÌïòÍµ¨','ÏÑúÍµ¨','ÏàòÏòÅÍµ¨','Ïó∞Ï†úÍµ¨','ÏòÅÎèÑÍµ¨','Ï§ëÍµ¨','Ìï¥Ïö¥ÎåÄÍµ¨'],
                'ÎåÄÍµ¨': ['ÎÇ®Íµ¨','Îã¨ÏÑúÍµ¨','Îã¨ÏÑ±Íµ∞','ÎèôÍµ¨','Î∂ÅÍµ¨','ÏÑúÍµ¨','ÏàòÏÑ±Íµ¨','Ï§ëÍµ¨'],
                'Ïù∏Ï≤ú': ['Í∞ïÌôîÍµ∞','Í≥ÑÏñëÍµ¨','ÎÇ®ÎèôÍµ¨','ÎèôÍµ¨','ÎØ∏Ï∂îÌôÄÍµ¨','Î∂ÄÌèâÍµ¨','ÏÑúÍµ¨','Ïó∞ÏàòÍµ¨','ÏòπÏßÑÍµ∞','Ï§ëÍµ¨'],
                'Í¥ëÏ£º': ['Í¥ëÏÇ∞Íµ¨','ÎÇ®Íµ¨','ÎèôÍµ¨','Î∂ÅÍµ¨','ÏÑúÍµ¨'],
                'ÎåÄÏ†Ñ': ['ÎåÄÎçïÍµ¨','ÎèôÍµ¨','ÏÑúÍµ¨','Ïú†ÏÑ±Íµ¨','Ï§ëÍµ¨'],
                'Ïö∏ÏÇ∞': ['ÎÇ®Íµ¨','ÎèôÍµ¨','Î∂ÅÍµ¨','Ïö∏Ï£ºÍµ∞','Ï§ëÍµ¨'],
                'ÏÑ∏Ï¢Ö': ['ÏÑ∏Ï¢ÖÏãú Ï†ÑÏ≤¥'],
                'Í≤ΩÍ∏∞': ['Í∞ÄÌèâÍµ∞','Í≥†ÏñëÏãú','Í≥ºÏ≤úÏãú','Í¥ëÎ™ÖÏãú','Í¥ëÏ£ºÏãú','Íµ¨Î¶¨Ïãú','Íµ∞Ìè¨Ïãú','ÍπÄÌè¨Ïãú','ÎÇ®ÏñëÏ£ºÏãú','ÎèôÎëêÏ≤úÏãú','Î∂ÄÏ≤úÏãú','ÏÑ±ÎÇ®Ïãú','ÏàòÏõêÏãú','ÏãúÌù•Ïãú','ÏïàÏÇ∞Ïãú','ÏïàÏÑ±Ïãú','ÏïàÏñëÏãú','ÏñëÏ£ºÏãú','ÏñëÌèâÍµ∞','Ïó¨Ï£ºÏãú','Ïó∞Ï≤úÍµ∞','Ïò§ÏÇ∞Ïãú','Ïö©Ïù∏Ïãú','ÏùòÏôïÏãú','ÏùòÏ†ïÎ∂ÄÏãú','Ïù¥Ï≤úÏãú','ÌååÏ£ºÏãú','ÌèâÌÉùÏãú','Ìè¨Ï≤úÏãú','ÌïòÎÇ®Ïãú','ÌôîÏÑ±Ïãú'],
                'Í∞ïÏõê': ['Í∞ïÎ¶âÏãú','Í≥†ÏÑ±Íµ∞','ÎèôÌï¥Ïãú','ÏÇºÏ≤ôÏãú','ÏÜçÏ¥àÏãú','ÏñëÍµ¨Íµ∞','ÏñëÏñëÍµ∞','ÏòÅÏõîÍµ∞','ÏõêÏ£ºÏãú','Ïù∏Ï†úÍµ∞','Ï†ïÏÑ†Íµ∞','Ï≤†ÏõêÍµ∞','Ï∂òÏ≤úÏãú','ÌÉúÎ∞±Ïãú','ÌèâÏ∞ΩÍµ∞','ÌôçÏ≤úÍµ∞','ÌôîÏ≤úÍµ∞','Ìö°ÏÑ±Íµ∞'],
                'Ï∂©Î∂Å': ['Í¥¥ÏÇ∞Íµ∞','Îã®ÏñëÍµ∞','Î≥¥ÏùÄÍµ∞','ÏòÅÎèôÍµ∞','Ïò•Ï≤úÍµ∞','ÏùåÏÑ±Íµ∞','Ï†úÏ≤úÏãú','Ï¶ùÌèâÍµ∞','ÏßÑÏ≤úÍµ∞','Ï≤≠Ï£ºÏãú','Ï∂©Ï£ºÏãú'],
                'Ï∂©ÎÇ®': ['Í≥ÑÎ£°Ïãú','Í≥µÏ£ºÏãú','Í∏àÏÇ∞Íµ∞','ÎÖºÏÇ∞Ïãú','ÎãπÏßÑÏãú','Î≥¥Î†πÏãú','Î∂ÄÏó¨Íµ∞','ÏÑúÏÇ∞Ïãú','ÏÑúÏ≤úÍµ∞','ÏïÑÏÇ∞Ïãú','ÏòàÏÇ∞Íµ∞','Ï≤úÏïàÏãú','Ï≤≠ÏñëÍµ∞','ÌÉúÏïàÍµ∞','ÌôçÏÑ±Íµ∞'],
                'Ï†ÑÎ∂Å': ['Í≥†Ï∞ΩÍµ∞','Íµ∞ÏÇ∞Ïãú','ÍπÄÏ†úÏãú','ÎÇ®ÏõêÏãú','Î¨¥Ï£ºÍµ∞','Î∂ÄÏïàÍµ∞','ÏàúÏ∞ΩÍµ∞','ÏôÑÏ£ºÍµ∞','ÏùµÏÇ∞Ïãú','ÏûÑÏã§Íµ∞','Ïû•ÏàòÍµ∞','Ï†ÑÏ£ºÏãú','Ï†ïÏùçÏãú','ÏßÑÏïàÍµ∞'],
                'Ï†ÑÎÇ®': ['Í∞ïÏßÑÍµ∞','Í≥†Ìù•Íµ∞','Í≥°ÏÑ±Íµ∞','Í¥ëÏñëÏãú','Íµ¨Î°ÄÍµ∞','ÎÇòÏ£ºÏãú','Îã¥ÏñëÍµ∞','Î™©Ìè¨Ïãú','Î¨¥ÏïàÍµ∞','Î≥¥ÏÑ±Íµ∞','ÏàúÏ≤úÏãú','Ïã†ÏïàÍµ∞','Ïó¨ÏàòÏãú','ÏòÅÍ¥ëÍµ∞','ÏòÅÏïîÍµ∞','ÏôÑÎèÑÍµ∞','Ïû•ÏÑ±Íµ∞','Ïû•Ìù•Íµ∞','ÏßÑÎèÑÍµ∞','Ìï®ÌèâÍµ∞','Ìï¥ÎÇ®Íµ∞','ÌôîÏàúÍµ∞'],
                'Í≤ΩÎ∂Å': ['Í≤ΩÏÇ∞Ïãú','Í≤ΩÏ£ºÏãú','Í≥†Î†πÍµ∞','Íµ¨ÎØ∏Ïãú','Íµ∞ÏúÑÍµ∞','ÍπÄÏ≤úÏãú','Î¨∏Í≤ΩÏãú','Î¥âÌôîÍµ∞','ÏÉÅÏ£ºÏãú','ÏÑ±Ï£ºÍµ∞','ÏïàÎèôÏãú','ÏòÅÎçïÍµ∞','ÏòÅÏñëÍµ∞','ÏòÅÏ£ºÏãú','ÏòÅÏ≤úÏãú','ÏòàÏ≤úÍµ∞','Ïö∏Î¶âÍµ∞','Ïö∏ÏßÑÍµ∞','ÏùòÏÑ±Íµ∞','Ï≤≠ÎèÑÍµ∞','Ï≤≠ÏÜ°Íµ∞','Ïπ†Í≥°Íµ∞','Ìè¨Ìï≠Ïãú'],
                'Í≤ΩÎÇ®': ['Í±∞Ï†úÏãú','Í±∞Ï∞ΩÍµ∞','Í≥†ÏÑ±Íµ∞','ÍπÄÌï¥Ïãú','ÎÇ®Ìï¥Íµ∞','Î∞ÄÏñëÏãú','ÏÇ¨Ï≤úÏãú','ÏÇ∞Ï≤≠Íµ∞','ÏñëÏÇ∞Ïãú','ÏùòÎ†πÍµ∞','ÏßÑÏ£ºÏãú','Ï∞ΩÎÖïÍµ∞','Ï∞ΩÏõêÏãú','ÌÜµÏòÅÏãú','ÌïòÎèôÍµ∞','Ìï®ÏïàÍµ∞','Ìï®ÏñëÍµ∞','Ìï©Ï≤úÍµ∞'],
                'Ï†úÏ£º': ['ÏÑúÍ∑ÄÌè¨Ïãú','Ï†úÏ£ºÏãú']
            },

            // ============ INIT ============
            init() {
                this.elements = {
                    messages: document.getElementById('messagesContainer'),
                    input: document.getElementById('inputSection'),
                    progressFill: document.getElementById('progressFill'),
                    progressLabel: document.getElementById('progressLabel'),
                    resetBtn: document.getElementById('resetBtn'),
                    modal: document.getElementById('resultModal'),
                    modalBody: document.getElementById('modalBody'),
                    closeModal: document.getElementById('closeModal'),
                    modalBackdrop: document.getElementById('modalBackdrop')
                };

                this.elements.resetBtn.onclick = () => this.reset();
                this.elements.closeModal.onclick = () => this.hideModal();
                this.elements.modalBackdrop.onclick = () => this.hideModal();

                this.showQuestion(0);
            },

            // ============ RESET ============
            reset() {
                this.state = {
                    currentStep: 0,
                    answers: {},
                    history: [],
                    services: [],
                    totalCount: 0,
                    currentPage: 1,
                    debugInfo: null
                };
                this.elements.messages.innerHTML = '';
                this.updateProgress(null);
                this.showQuestion(0);
            },

            // ============ NAVIGATION ============
            findNextQuestion(fromIndex) {
                for (let i = fromIndex + 1; i < this.questions.length; i++) {
                    const q = this.questions[i];
                    if (!q.condition) return i;
                    const match = Object.entries(q.condition).every(([k, v]) => this.state.answers[k] === v);
                    if (match) return i;
                }
                return -1;
            },

            goBack() {
                if (this.state.history.length === 0) return;

                const lastHistory = this.state.history.pop();
                const currentQ = this.questions[this.state.currentStep];
                if (currentQ) delete this.state.answers[currentQ.id];

                // ÎßàÏßÄÎßâ Î©îÏãúÏßÄ 2Í∞ú ÏÇ≠Ï†ú (Î¥á + Ïú†Ï†Ä)
                const msgs = this.elements.messages.querySelectorAll('.msg');
                let toRemove = 2;
                for (let i = msgs.length - 1; i >= 0 && toRemove > 0; i--) {
                    msgs[i].remove();
                    toRemove--;
                }

                this.state.currentStep = lastHistory.step;
                this.showQuestion(lastHistory.step, true);
            },

            // ============ PROGRESS ============
            updateProgress(progressInfo) {
                if (!progressInfo) {
                    this.elements.progressFill.style.width = '0%';
                    this.elements.progressLabel.textContent = 'ÏãúÏûëÌïòÍ∏∞';
                    return;
                }
                const pct = (progressInfo.current / progressInfo.total) * 100;
                this.elements.progressFill.style.width = pct + '%';
                this.elements.progressLabel.textContent = `${progressInfo.current}/${progressInfo.total} Îã®Í≥Ñ`;
            },

            // ============ MESSAGES ============
            addBotMessage(text) {
                const div = document.createElement('div');
                div.className = 'msg bot';
                div.innerHTML = `
                    <div class="msg-avatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                        </svg>
                    </div>
                    <div class="msg-bubble">${text.replace(/\n/g, '<br>')}</div>
                `;
                this.elements.messages.appendChild(div);
                this.scrollToBottom();
            },

            addUserMessage(text) {
                const div = document.createElement('div');
                div.className = 'msg user';
                div.innerHTML = `<div class="msg-bubble">${text}</div>`;
                this.elements.messages.appendChild(div);
                this.scrollToBottom();
            },

            showTyping() {
                const div = document.createElement('div');
                div.className = 'msg bot typing-msg';
                div.innerHTML = `
                    <div class="msg-avatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                        </svg>
                    </div>
                    <div class="msg-bubble">
                        <div class="typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                `;
                this.elements.messages.appendChild(div);
                this.scrollToBottom();
            },

            hideTyping() {
                const t = this.elements.messages.querySelector('.typing-msg');
                if (t) t.remove();
            },

            scrollToBottom() {
                this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
            },

            // ============ SHOW QUESTION ============
            showQuestion(index, isBack = false) {
                const q = this.questions[index];
                if (!q) {
                    this.submitAnswers();
                    return;
                }

                this.state.currentStep = index;
                this.updateProgress(q.progress || null);

                if (isBack) {
                    this.renderInput(q);
                    return;
                }

                this.showTyping();
                setTimeout(() => {
                    this.hideTyping();
                    this.addBotMessage(q.message);
                    this.renderInput(q);
                }, 500);
            },

            // ============ RENDER INPUT ============
            renderInput(q) {
                this.elements.input.innerHTML = '';
                const canGoBack = this.state.history.length > 0;

                switch (q.type) {
                    case 'single': this.renderSingle(q, canGoBack); break;
                    case 'multi': this.renderMulti(q, canGoBack); break;
                    case 'region': this.renderRegion(q, canGoBack); break;
                    case 'birthGender': this.renderBirthGender(q, canGoBack); break;
                }
            },

            createBackButton() {
                const btn = document.createElement('button');
                btn.className = 'btn-back';
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                    Ïù¥Ï†Ñ
                `;
                btn.onclick = () => this.goBack();
                return btn;
            },

            renderSingle(q, canGoBack) {
                const container = document.createElement('div');
                container.className = 'options-list ' + (q.gridClass || '');

                q.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-option';
                    btn.innerHTML = opt.sub
                        ? `${opt.label}<span class="sub">${opt.sub}</span>`
                        : opt.label;
                    btn.onclick = () => {
                        this.state.history.push({ step: this.state.currentStep });
                        this.addUserMessage(opt.label);
                        this.state.answers[q.id] = opt.value;
                        this.proceedNext();
                    };
                    container.appendChild(btn);
                });

                this.elements.input.appendChild(container);

                if (canGoBack) {
                    const row = document.createElement('div');
                    row.className = 'action-row';
                    row.appendChild(this.createBackButton());
                    this.elements.input.appendChild(row);
                }
            },

            renderMulti(q, canGoBack) {
                const container = document.createElement('div');
                container.className = 'options-list ' + (q.gridClass || '');
                const selected = new Set();

                q.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-option multi';
                    btn.textContent = opt.label;
                    btn.dataset.value = opt.value;
                    btn.onclick = () => {
                        if (opt.value === 'JA9999') {
                            selected.clear();
                            container.querySelectorAll('.btn-option').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            selected.add(opt.value);
                        } else {
                            const noneBtn = container.querySelector('[data-value="JA9999"]');
                            if (noneBtn) {
                                noneBtn.classList.remove('selected');
                                selected.delete('JA9999');
                            }
                            if (selected.has(opt.value)) {
                                selected.delete(opt.value);
                                btn.classList.remove('selected');
                            } else {
                                selected.add(opt.value);
                                btn.classList.add('selected');
                            }
                        }
                        confirmBtn.disabled = selected.size === 0;
                    };
                    container.appendChild(btn);
                });

                const actionRow = document.createElement('div');
                actionRow.className = 'action-row';

                if (canGoBack) {
                    actionRow.appendChild(this.createBackButton());
                }

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn-confirm';
                confirmBtn.textContent = 'ÏÑ†ÌÉù ÏôÑÎ£å';
                confirmBtn.disabled = true;
                confirmBtn.onclick = () => {
                    this.state.history.push({ step: this.state.currentStep });
                    const labels = [...selected].map(v => q.options.find(o => o.value === v)?.label || v);
                    this.addUserMessage(labels.join(', '));
                    this.state.answers[q.id] = [...selected];
                    this.proceedNext();
                };
                actionRow.appendChild(confirmBtn);

                this.elements.input.appendChild(container);
                this.elements.input.appendChild(actionRow);
            },

            renderRegion(q, canGoBack) {
                const container = document.createElement('div');
                container.className = 'select-group';

                const sidoSelect = document.createElement('select');
                sidoSelect.className = 'custom-select';
                sidoSelect.innerHTML = '<option value="">Ïãú/ÎèÑ ÏÑ†ÌÉù</option>' +
                    Object.keys(this.regions).map(r => `<option value="${r}">${r}</option>`).join('');

                const gugunSelect = document.createElement('select');
                gugunSelect.className = 'custom-select';
                gugunSelect.innerHTML = '<option value="">Ïãú/Íµ∞/Íµ¨ ÏÑ†ÌÉù</option>';
                gugunSelect.disabled = true;

                sidoSelect.onchange = () => {
                    gugunSelect.innerHTML = '<option value="">Ïãú/Íµ∞/Íµ¨ ÏÑ†ÌÉù</option>';
                    if (sidoSelect.value && this.regions[sidoSelect.value]) {
                        gugunSelect.disabled = false;
                        gugunSelect.innerHTML += this.regions[sidoSelect.value]
                            .map(g => `<option value="${g}">${g}</option>`).join('');
                    } else {
                        gugunSelect.disabled = true;
                    }
                    confirmBtn.disabled = true;
                };

                gugunSelect.onchange = () => {
                    confirmBtn.disabled = !gugunSelect.value;
                };

                const actionRow = document.createElement('div');
                actionRow.className = 'action-row';

                if (canGoBack) {
                    actionRow.appendChild(this.createBackButton());
                }

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn-confirm';
                confirmBtn.textContent = 'ÏÑ†ÌÉù ÏôÑÎ£å';
                confirmBtn.disabled = true;
                confirmBtn.onclick = () => {
                    this.state.history.push({ step: this.state.currentStep });
                    this.addUserMessage(`${sidoSelect.value} ${gugunSelect.value}`);
                    this.state.answers[q.id] = { sido: sidoSelect.value, gugun: gugunSelect.value };
                    this.proceedNext();
                };
                actionRow.appendChild(confirmBtn);

                container.appendChild(sidoSelect);
                container.appendChild(gugunSelect);
                this.elements.input.appendChild(container);
                this.elements.input.appendChild(actionRow);
            },

            renderBirthGender(q, canGoBack) {
                const container = document.createElement('div');
                container.className = 'birth-form';
                container.innerHTML = `
                    <div class="form-group">
                        <div class="form-label">ÏÉùÎÖÑÏõîÏùº</div>
                        <div class="birth-inputs">
                            <div class="input-wrap wide">
                                <input type="number" class="birth-input" id="inputYear" placeholder="1990" min="1900" max="2025">
                            </div>
                            <span class="input-suffix">ÎÖÑ</span>
                            <div class="input-wrap">
                                <input type="number" class="birth-input" id="inputMonth" placeholder="1" min="1" max="12">
                            </div>
                            <span class="input-suffix">Ïõî</span>
                            <div class="input-wrap">
                                <input type="number" class="birth-input" id="inputDay" placeholder="1" min="1" max="31">
                            </div>
                            <span class="input-suffix">Ïùº</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">ÏÑ±Î≥Ñ</div>
                        <div class="gender-buttons" id="genderButtons">
                            <button class="btn-option" data-gender="M">ÎÇ®ÏÑ±</button>
                            <button class="btn-option" data-gender="F">Ïó¨ÏÑ±</button>
                        </div>
                    </div>
                `;
                this.elements.input.appendChild(container);

                const actionRow = document.createElement('div');
                actionRow.className = 'action-row';

                if (canGoBack) {
                    actionRow.appendChild(this.createBackButton());
                }

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn-confirm';
                confirmBtn.textContent = 'ÏÑ†ÌÉù ÏôÑÎ£å';
                confirmBtn.disabled = true;
                actionRow.appendChild(confirmBtn);
                this.elements.input.appendChild(actionRow);

                const yearInput = document.getElementById('inputYear');
                const monthInput = document.getElementById('inputMonth');
                const dayInput = document.getElementById('inputDay');
                const genderBtns = document.getElementById('genderButtons');
                let selectedGender = '';

                const validate = () => {
                    const y = yearInput.value;
                    const m = monthInput.value;
                    const d = dayInput.value;
                    confirmBtn.disabled = !(y && y.length === 4 && m && d && selectedGender);
                };

                [yearInput, monthInput, dayInput].forEach(inp => inp.oninput = validate);

                genderBtns.querySelectorAll('.btn-option').forEach(btn => {
                    btn.onclick = () => {
                        genderBtns.querySelectorAll('.btn-option').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedGender = btn.dataset.gender;
                        validate();
                    };
                });

                confirmBtn.onclick = () => {
                    this.state.history.push({ step: this.state.currentStep });
                    const y = yearInput.value;
                    const m = monthInput.value.padStart(2, '0');
                    const d = dayInput.value.padStart(2, '0');
                    const genderText = selectedGender === 'M' ? 'ÎÇ®ÏÑ±' : 'Ïó¨ÏÑ±';
                    this.addUserMessage(`${y}ÎÖÑ ${m}Ïõî ${d}Ïùº, ${genderText}`);
                    this.state.answers[q.id] = { year: y, month: m, day: d, gender: selectedGender };
                    this.proceedNext();
                };
            },

            // ============ PROCEED ============
            proceedNext() {
                this.elements.input.innerHTML = '';
                const next = this.findNextQuestion(this.state.currentStep);
                if (next === -1) {
                    this.submitAnswers();
                } else {
                    setTimeout(() => this.showQuestion(next), 300);
                }
            },

            // ============ SUBMIT ============
            async submitAnswers() {
                this.elements.progressFill.style.width = '100%';
                this.elements.progressLabel.textContent = 'Í≤ÄÏÉâ Ï§ë...';
                this.showTyping();

                try {
                    console.log('Submitting answers:', this.state.answers);

                    const response = await fetch(CONFIG.API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.state.answers)
                    });

                    if (!response.ok) {
                        throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('API Response:', data);

                    if (data.error) {
                        throw new Error(data.message || 'API Ïò§Î•ò');
                    }

                    // ÏµúÎåÄ 1000Í∞ú Ï†úÌïú
                    this.state.services = (data.services || []).slice(0, CONFIG.MAX_ITEMS);
                    this.state.totalCount = data.totalCount || this.state.services.length;
                    this.state.currentPage = 1;
                    this.state.debugInfo = data.debug || null;

                    this.hideTyping();

                    const recCount = this.state.services.filter(s => s._score > 0).length;
                    let msg = `üéâ Í≤ÄÏÉâÏù¥ ÏôÑÎ£åÎêòÏóàÏñ¥Ïöî!\n\nÏ¥ù <strong>${this.state.totalCount.toLocaleString()}Í∞ú</strong>Ïùò ÏßÄÏõêÍ∏àÏùÑ Ï∞æÏïòÏäµÎãàÎã§.`;
                    if (recCount > 0) {
                        msg += `\n\n‚≠ê ÏûÖÎ†•ÌïòÏã† Ï°∞Í±¥Ïóê ÎßûÎäî <strong>${recCount}Í∞ú</strong>Ïùò Ï∂îÏ≤ú ÏßÄÏõêÍ∏àÏù¥ ÏÉÅÎã®Ïóê ÌëúÏãúÎê©ÎãàÎã§!`;
                    }
                    this.addBotMessage(msg);

                    setTimeout(() => this.showModal(), 400);

                } catch (err) {
                    console.error('Submit error:', err);
                    this.hideTyping();
                    this.addBotMessage(`Ï£ÑÏÜ°Ìï©ÎãàÎã§. Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${err.message}\n\nÏû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`);
                }
            },

            // ============ MODAL ============
            showModal() {
                this.renderModalContent();
                this.elements.modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            },

            hideModal() {
                this.elements.modal.classList.remove('show');
                document.body.style.overflow = '';
            },

            renderModalContent() {
                const { services, totalCount, currentPage, debugInfo } = this.state;
                const perPage = CONFIG.ITEMS_PER_PAGE;
                const totalPages = Math.ceil(services.length / perPage);
                const startIdx = (currentPage - 1) * perPage;
                const endIdx = Math.min(startIdx + perPage, services.length);
                const pageItems = services.slice(startIdx, endIdx);

                let html = '';

                if (services.length === 0) {
                    html = `
                        <div class="no-results">
                            <div class="no-results-icon">üîç</div>
                            <div class="no-results-title">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
                            <div class="no-results-desc">ÏÑ†ÌÉùÌïòÏã† Ï°∞Í±¥Ïóê ÎßûÎäî ÏßÄÏõêÍ∏àÏù¥ ÏóÜÏäµÎãàÎã§.</div>
                        </div>
                    `;
                } else {
                    // ÌÜµÍ≥Ñ
                    const recCount = services.filter(s => s._score > 0).length;
                    html += `
                        <div class="stats-grid">
                            <div class="stat-box primary">
                                <div class="stat-value">${totalCount.toLocaleString()}</div>
                                <div class="stat-label">Ï†ÑÏ≤¥ Í≤ÄÏÉâ Í≤∞Í≥º</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${recCount.toLocaleString()}</div>
                                <div class="stat-label">ÎßûÏ∂§ Ï∂îÏ≤ú</div>
                            </div>
                        </div>
                    `;

                    // ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
                    html += `
                        <div class="page-nav">
                            <button class="page-nav-btn" data-nav="prev" ${currentPage === 1 ? 'disabled' : ''}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 18 9 12 15 6"/>
                                </svg>
                                Ïù¥Ï†Ñ
                            </button>
                            <span class="page-nav-info">${currentPage} / ${totalPages} ÌéòÏù¥ÏßÄ</span>
                            <button class="page-nav-btn" data-nav="next" ${currentPage === totalPages ? 'disabled' : ''}>
                                Îã§Ïùå
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>
                            </button>
                        </div>
                    `;

                    // Í≤∞Í≥º Î™©Î°ù
                    html += '<div class="results-list">';
                    pageItems.forEach((item, idx) => {
                        const globalIdx = startIdx + idx;
                        const isRecommended = item._score > 0 && globalIdx < 10;

                        // ÎßÅÌÅ¨ ÏÉùÏÑ±
                        let link = '';
                        if (item.servDtlLink && item.servDtlLink.startsWith('http')) {
                            link = item.servDtlLink;
                        } else if (item.servId && item.servId !== `item-${item._index}`) {
                            link = `https://www.gov.kr/portal/rcvfvrSvc/dtlEx/${item.servId}`;
                        }

                        html += `
                            <div class="result-item${isRecommended ? ' recommended' : ''}">
                                <span class="result-badge">${item.svcfldNm || 'ÏßÄÏõêÍ∏à'}</span>
                                <h4 class="result-title">${globalIdx + 1}. ${item.servNm}</h4>
                                ${item.jurMnofNm ? `<p class="result-org">${item.jurMnofNm}</p>` : ''}
                                ${item.servDgst ? `<p class="result-desc">${item.servDgst}</p>` : ''}
                                ${link ? `
                                    <a href="${link}" target="_blank" rel="noopener noreferrer" class="result-link">
                                        ÏûêÏÑ∏Ìûà Î≥¥Í∏∞
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                            <polyline points="15 3 21 3 21 9"/>
                                            <line x1="10" y1="14" x2="21" y2="3"/>
                                        </svg>
                                    </a>
                                ` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';

                    // ÌïòÎã® ÌéòÏù¥ÏßÄ Î≤àÌò∏
                    if (totalPages > 1) {
                        html += '<div class="pagination">';

                        // Ï≤´ ÌéòÏù¥ÏßÄ
                        if (currentPage > 3) {
                            html += `<button class="page-num" data-page="1">1</button>`;
                            if (currentPage > 4) html += `<span class="page-num dots">...</span>`;
                        }

                        // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Ï£ºÎ≥Ä
                        for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                            html += `<button class="page-num${i === currentPage ? ' active' : ''}" data-page="${i}">${i}</button>`;
                        }

                        // ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄ
                        if (currentPage < totalPages - 2) {
                            if (currentPage < totalPages - 3) html += `<span class="page-num dots">...</span>`;
                            html += `<button class="page-num" data-page="${totalPages}">${totalPages}</button>`;
                        }

                        html += '</div>';
                    }
                }

                // ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê
                if (CONFIG.DEBUG && debugInfo) {
                    html += `
                        <div class="debug-panel show">
                            <div class="debug-title">üîß Debug Info</div>
                            <div class="debug-content">${JSON.stringify(debugInfo, null, 2)}</div>
                        </div>
                    `;
                }

                this.elements.modalBody.innerHTML = html;

                // Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© - ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
                const navBtns = this.elements.modalBody.querySelectorAll('.page-nav-btn');
                navBtns.forEach(btn => {
                    btn.onclick = () => {
                        if (btn.disabled) return;
                        const nav = btn.dataset.nav;
                        if (nav === 'prev') this.state.currentPage = Math.max(1, this.state.currentPage - 1);
                        if (nav === 'next') this.state.currentPage = Math.min(totalPages, this.state.currentPage + 1);
                        this.renderModalContent();
                        this.elements.modalBody.scrollTop = 0;
                    };
                });

                // Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© - ÌïòÎã® ÌéòÏù¥ÏßÄ Î≤àÌò∏
                const pageBtns = this.elements.modalBody.querySelectorAll('.page-num[data-page]');
                pageBtns.forEach(btn => {
                    btn.onclick = () => {
                        if (btn.classList.contains('active')) return;
                        this.state.currentPage = parseInt(btn.dataset.page);
                        this.renderModalContent();
                        this.elements.modalBody.scrollTop = 0;
                    };
                });
            }
        };

        // ============ START ============
        document.addEventListener('DOMContentLoaded', () => App.init());
    })();
    </script>
</body>
</html>
